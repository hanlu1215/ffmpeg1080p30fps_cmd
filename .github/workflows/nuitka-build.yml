name: Nuitka Build (Ubuntu 22.04)

on:
  push:
    tags: [ 'v*.*.*' ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write       # 必须有 write 权限才能创建 release / 上传 asset
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0     # 如果后面想自动生成 changelog 可以拉全历史

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          # 安装 FFmpeg（包含 ffprobe）以及基础运行时库
          sudo apt-get install -y --no-install-recommends ffmpeg libglib2.0-0 || true
          python -m pip install --upgrade pip
          # 本脚本不依赖第三方 Python 包，Nuitka 及可选压缩库足够
          python -m pip install nuitka zstandard

      - name: Build with Nuitka (direct invocation)
        run: |
          # 打包脚本为单文件二进制，尝试静态链接 libpython
          python -m nuitka \
            --onefile \
            --output-dir=dist \
            --output-filename=ffmpeg1080p30fps_cmd \
            --lto=yes \
            --static-libpython=yes \
            ffmpeg1080p30fps_cmd.py

      - name: List built files (for debug)
        run: |
          ls -la dist || true
          file dist/ffmpeg1080p30fps_cmd* || true
          du -sh dist/ffmpeg1080p30fps_cmd* || true

      - name: Rename binary to include version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "Renaming built binary to include tag name"
          mv dist/ffmpeg1080p30fps_cmd dist/ffmpeg1080p30fps_cmd-${{ github.ref_name }}_ubuntu2204
          ls -la dist || true

      # ──────────────────────────────── release ──────────────────────────────────

      - name: Upload binary to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          # 如果 tag 已存在 → 会自动追加 asset，不会重复创建 release
          # 如果 tag 不存在 → 会自动创建 release
          tag_name: ${{ github.ref_name }}           # 自动使用当前 tag
          name: Release ${{ github.ref_name }}
          fail_on_unmatched_files: true
          generate_release_notes: true               # 自动生成 release notes（基于 commits）
          files: |
            dist/ffmpeg1080p30fps_cmd-${{ github.ref_name }}_ubuntu2204
